name: Build and Deploy MAU on Hospital Server

on:
  push:
    branches: [main, production]

env:
  DEPLOYMENT_TIME: ${{ github.event.head_commit.timestamp }}
  COMMIT_SHA: ${{ github.sha }}

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify Docker installation
        run: |
          docker --version
          if command -v docker-compose &> /dev/null; then
            echo "Using docker-compose (hyphenated)"
            docker-compose --version
            echo "DOCKER_COMPOSE_CMD=docker-compose" >> $GITHUB_ENV
          elif docker compose version &> /dev/null; then
            echo "Using docker compose (plugin)"
            docker compose version
            echo "DOCKER_COMPOSE_CMD=docker compose" >> $GITHUB_ENV
          else
            echo "Error: Neither docker-compose nor docker compose found"
            exit 1
          fi

      - name: Build and tag backend image
        run: |
          docker build -t ghcr.io/jlrochin/mau-backend:latest -f Dockerfile .

      - name: Build and tag frontend image
        run: |
          docker build -t ghcr.io/jlrochin/mau-frontend:latest -f Dockerfile.frontend ./frontend

      - name: Restart MAU services
        run: |
          ${{ env.DOCKER_COMPOSE_CMD }} -f docker-compose.yml up -d --no-deps --build mau-backend mau-frontend

      - name: Wait for services to be healthy
        run: |
          sleep 15
          docker ps | grep mau

      - name: Run backend migrations
        run: |
          docker exec mau-backend python manage.py migrate --noinput || true

      - name: Verify deployment
        run: |
          echo "Deployment completed at $(date)"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          ${{ env.DOCKER_COMPOSE_CMD }} ps

      - name: Cleanup old images
        run: |
          docker image prune -f
